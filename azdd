--1
local replicatedStorage = game:GetService("ReplicatedStorage")
local collectionService = game:GetService("CollectionService")
local players = game:GetService("Players")
local localPlayer = players.LocalPlayer

-- Get hatchFunction and internal data
local hatchFunction = getupvalue(getupvalue(getconnections(replicatedStorage.GameEvents.PetEggService.OnClientEvent)[1].Function, 1), 2)
local eggModels = getupvalue(hatchFunction, 1)
local eggPets = getupvalue(hatchFunction, 2)

-- Tables
local activeEggs = {}
local eggInfoList = {}

-- Get object by UUID
local function getObjectFromId(objectId)
	for _, eggModel in pairs(eggModels) do
		if eggModel:GetAttribute("OBJECT_UUID") == objectId then
			return eggModel
		end
	end
end

-- Update hatched pet info
local function UpdateEggPetName(objectId, petName)
	local object = getObjectFromId(objectId)
	if not object then return end

	local eggName = object:GetAttribute("EggName")
	for _, data in pairs(eggInfoList) do
		if data.id == objectId then
			data.pet = petName
			refreshPetPredictDropdown()
			return
		end
	end
end

-- Store egg info
local function RegisterEgg(object)
	if object:GetAttribute("OWNER") ~= localPlayer.Name then return end

	local eggName = object:GetAttribute("EggName")
	local petName = eggPets[object:GetAttribute("OBJECT_UUID")]
	local objectId = object:GetAttribute("OBJECT_UUID")
	if not objectId then return end

	activeEggs[objectId] = object

	table.insert(eggInfoList, {
		egg = eggName,
		pet = petName or "?",
		id = objectId,
	})
	refreshPetPredictDropdown()
end

-- Cleanup
local function RemoveEgg(object)
	if object:GetAttribute("OWNER") ~= localPlayer.Name then return end
	local objectId = object:GetAttribute("OBJECT_UUID")
	activeEggs[objectId] = nil
end

-- Setup existing eggs
for _, object in collectionService:GetTagged("PetEggServer") do
	task.spawn(RegisterEgg, object)
end

-- Connect future eggs
collectionService:GetInstanceAddedSignal("PetEggServer"):Connect(RegisterEgg)
collectionService:GetInstanceRemovedSignal("PetEggServer"):Connect(RemoveEgg)

-- Hook hatch event
local old
old = hookfunction(getconnections(replicatedStorage.GameEvents.EggReadyToHatch_RE.OnClientEvent)[1].Function, newcclosure(function(objectId, petName)
	UpdateEggPetName(objectId, petName)
	return old(objectId, petName)
end))

-- === UI Code ===

-- Get dropdown values (pet names with duplicates)
local function getAllPetNamesWithDuplicates()
	local list = {}
	for _, data in pairs(eggInfoList) do
		if data.pet and data.pet ~= "?" then
			table.insert(list, data.pet)
		end
	end
	-- Return empty list if none found
	return list or {}
end

-- Get dropdown description text (petname + eggname)
local function getPetNameEggNameDesc()
	local lines = {}
	for _, data in pairs(eggInfoList) do
		if data.pet and data.pet ~= "?" then
			table.insert(lines, data.pet .. " (" .. data.egg .. ")")
		end
	end
	-- Return empty string if none found
	if #lines == 0 then
		return ""
	end
	return table.concat(lines, "\n")
end

-- Reference to dropdown for updates
local PetPredictDropdown = nil

function refreshPetPredictDropdown()
	if PetPredictDropdown then
		local values = getAllPetNamesWithDuplicates()
		PetPredictDropdown:SetValues(values)
		PetPredictDropdown:SetDesc(getPetNameEggNameDesc())
	end
end

-- Highlight and ESP management
local activeHighlights = {}

local function clearAllHighlights()
	for _, highlightData in pairs(activeHighlights) do
		if highlightData.Highlight then
			highlightData.Highlight:Destroy()
		end
		if highlightData.Billboard then
			highlightData.Billboard:Destroy()
		end
	end
	activeHighlights = {}
end

local function createHighlight(object, petName)
	-- Highlight
	local highlight = Instance.new("Highlight")
	highlight.Adornee = object
	highlight.FillColor = Color3.fromRGB(255, 255, 0)
	highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Parent = object

	-- ESP Label
	local billboard = Instance.new("BillboardGui")
	billboard.Adornee = object
	billboard.Size = UDim2.new(0, 100, 0, 30)
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = object

	local textLabel = Instance.new("TextLabel")
	textLabel.Size = UDim2.new(1, 0, 1, 0)
	textLabel.BackgroundTransparency = 1
	textLabel.TextColor3 = Color3.new(1, 1, 0)
	textLabel.TextStrokeTransparency = 0
	textLabel.Text = petName
	textLabel.TextScaled = true
	textLabel.Font = Enum.Font.SourceSansBold
	textLabel.Parent = billboard

	activeHighlights[object] = {
		Highlight = highlight,
		Billboard = billboard,
	}
end

function refreshPetPredictHighlights(selectedPets)
	clearAllHighlights()
	for _, data in pairs(eggInfoList) do
		if table.find(selectedPets, data.pet) then
			local eggObject = activeEggs[data.id]
			if eggObject then
				createHighlight(eggObject, data.pet)
			end
		end
	end
end

-- Create dropdown UI
PetPredictDropdown = Tabs.Secret:Dropdown({
	Title = "Egg Pet Names List (ready to hatch only)",
	Desc = getPetNameEggNameDesc(),
	Value = {},
	Multi = true,
	AllowNone = true,
	Values = getAllPetNamesWithDuplicates(),
	Callback = function(selected)
		refreshPetPredictHighlights(selected)
	end,
})

-- === Pet Needed Dropdown ===
PetNeededState = settings["PetNeeded"] or {}

PetNeededDropdown = Tabs.Secret:Dropdown({
	Title = "Desire Pet",
	Value = PetNeededState,
	Multi = true,
	AllowNone = true,
	Values = {
		"Queen Bee",
		"Dragonfly",
		"Polar Bear",
		"Disco Bee",
		"Butterfly",
		"Raccoon",
		"Red Fox",
	},
	Callback = function(selected)
		settings["PetNeeded"] = selected
		saveSettings(settings)
	end,
})

-- === Server Hop Toggle ===
PetNeededServerHopState = settings["ServerHopNeedPet"] or false

Tabs.Secret:Toggle({
	Title = "Server Hop Desire Pet",
	Value = PetNeededServerHopState,
	Icon = "check",
	Type = "Checkbox",
	Callback = function(val)
		settings["ServerHopNeedPet"] = val
		saveSettings(settings)
	end,
})


task.spawn(function()
	local HttpService = game:GetService("HttpService")

	local function sendWebhookNotification(petName)
		--this webhookUrl is from players inputed webhook, only them can access
		local url = settings["WebhookUrl"]
		if not url or url == "" then return end

		local discordId = settings["DiscordUserID"]
		local content = discordId and ("<@" .. discordId .. ">") or ""

		local data = {
			content = content,
			embeds = {{
				title = "ðŸŽ‰ Pet Found!",
				description = "A desired pet has been detected in the egg list.",
				color = 65280,
				fields = {
					{ name = "Pet Name", value = petName, inline = true },
				},
				footer = { text = "Pet ESP System" },
				timestamp = DateTime.now():ToIsoDate(),
			}},
		}

		local success, err = pcall(function()
			HttpService:PostAsync(url, HttpService:JSONEncode(data), Enum.HttpContentType.ApplicationJson)
		end)

		if not success then
			warn("Failed to send webhook:", err)
		end
	end

	while task.wait(10) do
		if settings["ServerHopNeedPet"] then
			local found = false
			for _, data in pairs(eggInfoList) do
				if table.find(settings["PetNeeded"] or {}, data.pet) then
					found = true
					settings["ServerHopNeedPet"] = false
					saveSettings(settings)

					--this is not from my webhook.I dont get any data from u
					sendWebhookNotification(data.pet)

					WindUI:Notify({
						Title = "Desire Pet Detected",
						Icon = "check",
						Duration = 5, 
					})

					print("[SERVER HOP] Desired pet found! Cancelling server hop.")
					break
				end
			end

			if not found then
				WindUI:Notify({
					Title = "No Desire Pet Detected",
					Icon = "x",
					Duration = 5, 
				})
                task.wait(5)

				local TeleportService = game:GetService("TeleportService")
				local placeId = game.PlaceId
				TeleportService:Teleport(placeId)
			end
		end
	end
end)
